<section class="scope12-mobile">
  <div class="section-header">
    <div>
      <h3>1.2 Mobile combustion</h3>
      <p>กรอกข้อมูลรถใช้น้ำมันแต่ละประเภท (ตาม slot ใน Excel)</p>
    </div>
    <div class="header-actions">
      <button mat-stroked-button (click)="openReview()">
        <mat-icon>preview</mat-icon>
        Review
      </button>
      <button mat-raised-button color="primary" (click)="exportSheet()" [disabled]="exporting">
        <mat-icon *ngIf="!exporting">download</mat-icon>
        <mat-progress-spinner *ngIf="exporting" diameter="18" mode="indeterminate"></mat-progress-spinner>
        <span>{{ exporting ? 'กำลัง Export...' : 'Export (this sheet)' }}</span>
      </button>
    </div>
  </div>

  <div class="group" *ngFor="let key of groups">
    <div class="group-header">
      <h4>{{ labelFor(key) }}</h4>
      <button mat-stroked-button color="primary" (click)="addRow(key)" [disabled]="!canAdd(key)">
        <mat-icon>add</mat-icon>
        เพิ่มรายการ
      </button>
    </div>

    <div class="table-wrapper">
      <table class="monthly-table">
        <thead>
          <tr>
            <th rowspan="2">รายการ</th>
            <th rowspan="2">หลักฐาน</th>
            <th rowspan="2">หน่วย</th>
            <th rowspan="2">รวม</th>
            <th [attr.colspan]="months.length">ปริมาณการใช้แต่ละเดือน/2566</th>
            <th rowspan="2">ลบ</th>
          </tr>
          <tr>
            <th *ngFor="let m of months">{{ m }}</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let row of groupRows(key)">
            <td>
              <input type="text" [ngModel]="row.itemName" (ngModelChange)="updateItemName(row, $event)" />
            </td>
            <td>
              <input type="text" [ngModel]="row.referenceText" (ngModelChange)="updateEvidence(row, $event)" />
            </td>
            <td>{{ row.unit || 'L' }}</td>
            <td class="num">{{ total(row) | number: '1.0-2' }}</td>
            <td *ngFor="let m of months">
              <input
                type="number"
                [ngModel]="getMonthQty(row, m)"
                (ngModelChange)="updateMonthQty(row, m, $event)"
              />
            </td>
            <td>
              <button mat-icon-button color="warn" (click)="removeRow(row)">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </tr>
          <tr class="summary">
            <td colspan="3">รวม ({{ labelFor(key) }})</td>
            <td class="num">{{ totalAll(key) | number: '1.0-2' }}</td>
            <td [attr.colspan]="months.length + 1"></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="group">
    <div class="group-header">
      <h4>{{ labelFor('DIESEL_B7_OFFROAD') }}</h4>
    </div>

    <div class="table-wrapper">
      <table class="monthly-table">
        <thead>
          <tr>
            <th rowspan="2">รายการ</th>
            <th rowspan="2">หลักฐาน</th>
            <th rowspan="2">หน่วย</th>
            <th rowspan="2">รวม</th>
            <th [attr.colspan]="months.length">ปริมาณการใช้แต่ละเดือน/2566</th>
          </tr>
          <tr>
            <th *ngFor="let m of months">{{ m }}</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <input
                type="text"
                [ngModel]="ensureOffroadRow().itemName"
                (ngModelChange)="updateItemName(ensureOffroadRow(), $event)"
              />
            </td>
            <td>
              <input
                type="text"
                [ngModel]="ensureOffroadRow().referenceText"
                (ngModelChange)="updateEvidence(ensureOffroadRow(), $event)"
              />
            </td>
            <td>{{ ensureOffroadRow().unit || 'L' }}</td>
            <td class="num">{{ total(ensureOffroadRow()) | number: '1.0-2' }}</td>
            <td *ngFor="let m of months">
              <input
                type="number"
                [ngModel]="getMonthQty(ensureOffroadRow(), m)"
                (ngModelChange)="updateMonthQty(ensureOffroadRow(), m, $event)"
              />
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>
