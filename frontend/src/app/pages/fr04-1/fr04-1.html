<div class="page-header">
  <div>
    <h2>FR-04.1 (Current year) – บัญชีรายการก๊าซเรือนกระจก</h2>
    <div class="sub">Cycle ID: {{ cycleId }}</div>
  </div>

  <div class="header-actions">
    <button mat-stroked-button (click)="goScope3Screen()">
      <mat-icon>table_view</mat-icon>
      Scope 3 Summary
    </button>

    <button mat-stroked-button (click)="goFr032()">
      <mat-icon>description</mat-icon>
      FR-03.2
    </button>

    <button mat-raised-button color="primary" (click)="exportVSheet()" [disabled]="exporting">
      <mat-icon>download</mat-icon>
      Export v-sheet
    </button>
  </div>
</div>

<mat-card class="card">
  <div class="grid">
    <mat-form-field appearance="outline" class="w-320">
      <mat-label>Export template</mat-label>
      <mat-select [(ngModel)]="templateId">
        <mat-option value="MBAX_TGO_11102567">MBAX-TGO-11102567 (Demo)</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-slide-toggle [(ngModel)]="useModernExcel">
      Modern Excel features (XLOOKUP/FILTER)
    </mat-slide-toggle>
  </div>

  <div class="hint">
    FR-04.1 จะดึงรายการ Scope 3 จาก FR-03.2 เฉพาะที่ <b>มีนัยสำคัญ</b> และ <b>เลือกประเมิน</b> (Top 6 ตาม GHG)
  </div>

  <mat-divider></mat-divider>

  <div class="table-wrap">
    <table mat-table [dataSource]="previewRows" class="mat-elevation-z0">

      <ng-container matColumnDef="subScope">
        <th mat-header-cell *matHeaderCellDef>No. TGO</th>
        <td mat-cell *matCellDef="let r">{{ r.subScope }}</td>
      </ng-container>

      <ng-container matColumnDef="isoNo">
        <th mat-header-cell *matHeaderCellDef>ISO</th>
        <td mat-cell *matCellDef="let r">{{ r.isoNo }}</td>
      </ng-container>

      <ng-container matColumnDef="itemLabel">
        <th mat-header-cell *matHeaderCellDef>รายการ</th>
        <td mat-cell *matCellDef="let r">{{ r.itemLabel }}</td>
      </ng-container>

      <ng-container matColumnDef="ghgTco2e">
        <th mat-header-cell *matHeaderCellDef>GHG (tCO2eq.)</th>
        <td mat-cell *matCellDef="let r" class="num">{{ fmt(r.ghgTco2e, 2) }}</td>
      </ng-container>

      <ng-container matColumnDef="sharePct">
        <th mat-header-cell *matHeaderCellDef>%</th>
        <td mat-cell *matCellDef="let r" class="num">{{ fmt(r.sharePct, 2) }}</td>
      </ng-container>

      <ng-container matColumnDef="assessment">
        <th mat-header-cell *matHeaderCellDef>ผลการประเมิน</th>
        <td mat-cell *matCellDef="let r">{{ r.assessment }}</td>
      </ng-container>

      <ng-container matColumnDef="selection">
        <th mat-header-cell *matHeaderCellDef>ผลการคัดเลือก</th>
        <td mat-cell *matCellDef="let r">{{ r.selection }}</td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>
  </div>
</mat-card>

<mat-card class="card" *ngIf="exportError">
  <div class="error">{{ exportError }}</div>
</mat-card>

<mat-card class="card" *ngIf="report">
  <div class="title">Validation report</div>
  <div class="sub">Template: {{ report.templateId }} v{{ report.version }}</div>
  <mat-divider></mat-divider>
  <div class="report">
    <div class="r" *ngFor="let v of report.validations">
      <div class="id">{{ v.id }}</div>
      <div class="lvl">{{ v.level }}</div>
      <div class="ok" [class.bad]="!v.ok">{{ v.ok ? 'OK' : 'FAIL' }}</div>
      <div class="msg" *ngIf="v.message">{{ v.message }}</div>
    </div>
  </div>
</mat-card>
